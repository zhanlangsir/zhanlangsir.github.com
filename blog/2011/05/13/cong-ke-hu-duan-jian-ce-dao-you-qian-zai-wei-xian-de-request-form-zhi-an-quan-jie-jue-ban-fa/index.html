
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>从客户端检测到有潜在危险的Request.Form值安全解决办法（转） - 挨踢人生</title>
  <meta name="author" content="zhanlang">

  
  <meta name="description" content="写的不错，虽然有很多时候有很多方法可以达到某一目的，但是要考虑一下代价。 asp.net开发中，经常遇到“从客户端检测到有潜在危险的Request.Form 值”错误提示，很多人给出的解决方案是： 1、web.config文档&lt;system.web>后面加入这一句： 示例： &lt;?xml &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://zhanlangsir.github.com/blog/2011/05/13/cong-ke-hu-duan-jian-ce-dao-you-qian-zai-wei-xian-de-request-form-zhi-an-quan-jie-jue-ban-fa/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="挨踢人生" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">挨踢人生</a></h1>
  
    <h2>做一个有思想的人</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:zhanlangsir.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">从客户端检测到有潜在危险的Request.Form值安全解决办法（转）</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-05-13T00:00:00+08:00" pubdate data-updated="true">May 13<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>写的不错，虽然有很多时候有很多方法可以达到某一目的，但是要考虑一下代价。</p>

<p>asp.net开发中，经常遇到“从客户端检测到有潜在危险的Request.Form 值”错误提示，很多人给出的解决方案是：</p>

<p>1、web.config文档&lt;system.web>后面加入这一句： <pages validaterequest="false"/>
示例：</p>

<p>&lt;?xml version=&#8221;1.0&#8221; encoding=&#8221;gb2312&#8221; ?>
<configuration>
&lt;system.web>
<pages validaterequest="false"/>
&lt;/system.web>
</configuration></p>

<p>2、在*.aspx文档头的page中加入validaterequest=&#8221;false&#8221;,示例如下：
&lt;%@ page validaterequest=&#8221;false&#8221; language=&#8221;c#&#8221; codebehind=&#8221;index.aspx.cs&#8221; autoeventwireup=&#8221;false&#8221; inherits=&#8221;mybbs.webform1&#8221; %></p>

<!--more-->


<p>其实这样做是不正确的，会给程序安全带来风险。</p>

<p>ASP.Net 1.1后引入了对提交表单自动检查是否存在XSS(跨站脚本攻击)的能力。当用户试图用之类的输入影响页面返回结果的时候，ASP.Net的引擎会引发一个 HttpRequestValidationExceptioin。这是ASP.Net提供的一个很重要的安全特性。因为很多程序员对安全没有概念，甚至都不知道XSS这种攻击的存在，知道主动去防护的就更少了。ASP.Net在这一点上做到默认安全。这样让对安全不是很了解的程序员依旧可以写出有一定安全防护能力的网站。</p>

<p>但是，当我Google搜索 HttpRequestValidationException 或者 &#8220;A potentially dangerous Request.Form value was detected from the client&#8221;的时候，惊奇的发现大部分人给出的解决方案竟然是在ASP.Net页面描述中通过设置 validateRequest=false 来禁用这个特性，而不去关心那个程序员的网站是否真的不需要这个特性。看得我这叫一个胆战心惊。安全意识应该时时刻刻在每一个程序员的心里，不管你对安全的概念了解多少，一个主动的意识在脑子里，你的站点就会安全很多。
为什么很多程序员想要禁止 validateRequest 呢?有一部分是真的需要用户输入&#8221;&lt;>&#8221;之类的字符。这就不必说了。还有一部分其实并不是用户允许输入那些容易引起XSS的字符，而是讨厌这种报错的形式，毕竟一大段英文加上一个ASP.Net典型异常错误信息，显得这个站点出错了，而不是用户输入了非法的字符，可是自己又不知道怎么不让它报错，自己来处理报错。</p>

<p>对于希望很好的处理这个错误信息，而不使用默认ASP.Net异常报错信息的程序员们，你们不要禁用validateRequest=false。</p>

<p>正确的做法是在你当前页面添加Page_Error()函数，来捕获所有页面处理过程中发生的而没有处理的异常。然后给用户一个合法的报错信息。如果当前页面没有Page_Error()，这个异常将会送到Global.asax的Application_Error()来处理，你也可以在那里写通用的异常报错处理函数。如果两个地方都没有写异常处理函数，才会显示这个默认的报错页面呢。</p>

<p>举例而言，处理这个异常其实只需要很简短的一小段代码就够了。在页面的Code-behind页面中加入这么一段代码：
protected void Page_Error(object sender, EventArgs e)
{
Exception ex = Server.GetLastError();
if (HttpContext.Current.Server.GetLastError() is HttpRequestValidationException)
{
HttpContext.Current.Response.Write(&#8220;请输入合法的字符串【<a href="javascript:history.back(0);">返回</a>】&#8221;);
HttpContext.Current.Server.ClearError();
}
}</p>

<p>这样这个程序就可以截获 HttpRequestValidationException 异常，而且可以按照程序员的意愿返回一个合理的报错信息。
这段代码很简单，所以我希望所有不是真的要允许用户输入之类字符的朋友，千万不要随意的禁止这个安全特性，如果只是需要异常处理，那么请用类似于上面的代码来处理即可。</p>

<p>而对于那些通过 明确禁止了这个特性的程序员，自己一定要明白自己在做什么，而且一定要自己手动的检查必须过滤的字符串，否则你的站点很容易引发跨站脚本攻击。
关于存在Rich Text Editor的页面应该如何处理?</p>

<p>如果页面有富文本编辑器的控件的，那么必然会导致有类的HTML标签提交回来。在这种情况下，我们不得不将validateRequest=&#8221;false&#8221;。那么安全性怎么处理?如何在这种情况下最大限度的预防跨站脚本攻击呢?</p>

<p>根据微软的建议，我们应该采取安全上称为“默认禁止，显式允许”的策略。</p>

<p>首先，我们将输入字符串用 HttpUtility.HtmlEncode()来编码，将其中的HTML标签彻底禁止。</p>

<p>然后，我们再对我们所感兴趣的、并且是安全标签，通过Replace()进行替换。比如，我们希望有&#8221;&#8220;标签，那么我们就将&#8221;&#8220;显式的替换回&#8221;&#8220;。</p>

<p>void submitBtn_Click(object sender, EventArgs e)
{
//将输入字符串编码，这样所有的HTML标签都失效了。
StringBuilder sb = new StringBuilder(HttpUtility.HtmlEncode(htmlInputTxt.Text));
//然后我们选择性的允许<b> 和 <i>
sb.Replace(&#8220;&lt;b&gt;&#8221;, &#8221;<b>&#8221;);
sb.Replace(&#8220;&lt;/b&gt;&#8221;, &#8221;</b>&#8221;);
sb.Replace(&#8220;&lt;i&gt;&#8221;, &#8221;<i>&#8221;);
sb.Replace(&#8220;&lt;/i&gt;&#8221;, &#8221;</i>&#8221;);
Response.Write(sb.ToString());
}
这样我们即允许了部分HTML标签，又禁止了危险的标签。</p>

<p>根据微软提供的建议，我们要慎重允许下列HTML标签，因为这些HTML标签都是有可能导致跨站脚本攻击的。</p>

<p><applet>
<body>
<embed>
<frame></p>

<script>
<frameset>
<html>
<iframe>
<img>
<style>
<layer>
<link>
<ilayer>
<meta>
<object>


可能这里最让人不能理解的是<img>。但是，看过下列代码后，就应该明白其危险性了。


 
 
<span style="line-height: 25px; font-size: x-small;">以下是引用片段：</span>
<span style="line-height: 25px; font-size: x-small;"><img src="javascript:alert('hello');"></span>
<span style="line-height: 25px; font-size: x-small;"><img src="java script:alert('hello');"></span>
<span style="line-height: 25px; font-size: x-small;"><img src="java script:alert('hello');"></span>
<span style="line-height: 25px; font-size: x-small;">通过<img>标签是有可能导致javascript执行的，这样攻击者就可以做他想伪装的任何事情。</span>
<span style="line-height: 25px; font-size: x-small;">关于<style>也是一样：</span>
<span style="line-height: 25px; font-size: x-small;">以下是引用片段：</span>
<span style="line-height: 25px; font-size: x-small;"><style TYPE="text/javascript">...</span>
<span style="line-height: 25px; font-size: x-small;">alert('hello');</span>
<span style="line-height: 25px; font-size: x-small;"></style></span>
<span style="line-height: 25px; font-size: x-small;">从客户端中检测到有潜在危险的 Request.Form 值</span>
<span style="line-height: 25px; font-size: x-small;">由于在.net中，Request时出现有HTML或Javascript等字符串时，系统会认为是危险性值。立马报错上面的错误。</span>
<span style="line-height: 25px; font-size: x-small;">解决办法：</span>
<span style="line-height: 25px; font-size: x-small;">解决方案一：</span>
<span style="line-height: 25px; font-size: x-small;">在.aspx文件头中加入这句：</span>
<span style="line-height: 25px; font-size: x-small;"><%@ Page validateRequest="false"   %></span>
<span style="line-height: 25px; font-size: x-small;">解决方案二：</span>
<span style="line-height: 25px; font-size: x-small;">修改web.config文件:</span>
<span style="line-height: 25px; font-size: x-small;"><configuration></span>
<span style="line-height: 25px; font-size: x-small;"><system.web></span>
<span style="line-height: 25px; font-size: x-small;"><pages validateRequest="false" /></span>
<span style="line-height: 25px; font-size: x-small;"></system.web></span>
<span style="line-height: 25px; font-size: x-small;"></configuration></span>
<span style="line-height: 25px; font-size: x-small;">因为validateRequest默认值为true。只要设为false即可。</span>
<span style="line-height: 25px; font-size: x-small;">当然，这样只能是让界面好看一些，要想抵制注入，还得从过滤上做足功夫</span>
<span style="line-height: 25px; font-size: x-small;">然后，还是有不禁用validateRequest的方法的，如下</span>
<span style="line-height: 25px; font-size: x-small;">不禁用validateRequest=false。</span>
<span style="line-height: 25px; font-size: x-small;">正确的做法是在你当前页面添加Page_Error()函数，来捕获所有页面处理过程中发生的而没有处理的异常。然后给用户一个合法的报错信息。如果当前页面没有Page_Error()，这个异常将会送到Global.asax的Application_Error()来处理，你也可以在那里写通用的异常报错处理函数。如果两个地方都没有写异常处理函数，才会显示这个默认的报错页面呢。</span>
<span style="line-height: 25px; font-size: x-small;">举例而言，处理这个异常其实只需要很简短的一小段代码就够了。在页面的Code-behind页面中加入这么一段代码： </span>
<span style="line-height: 25px; font-size: x-small;">以下是引用片段：</span>
<span style="line-height: 25px; font-size: x-small;">protected void Page_Error(object sender, EventArgs e)</span>
<span style="line-height: 25px; font-size: x-small;">{</span>
<span style="line-height: 25px; font-size: x-small;">Exception ex = Server.GetLastError();</span>
<span style="line-height: 25px; font-size: x-small;">if (ex is HttpRequestValidationException)</span>
<span style="line-height: 25px; font-size: x-small;">{</span>
<span style="line-height: 25px; font-size: x-small;">Response.Write("请您输入合法字符串。");</span>
<span style="line-height: 25px; font-size: x-small;">Server.ClearError(); // 如果不ClearError()这个异常会继续传到Application_Error()。</span>
<span style="line-height: 25px; font-size: x-small;">}</span>
<span style="line-height: 25px; font-size: x-small;">}</span>
 

 

注：

还需将

httpRuntime requestValidationMode设置为framework2.0模式，在web.config中加入以下句子。

 

<system.web>

<httpRuntime requestValidationMode="2.0"/>

</system.web>

 

在转这篇文章的时候，已经没有源文章链接，所以不加源文章地址！

还有另一篇关于请求验证的文章，请看这里：<a href="http://www.aitilife.com/post/2011/05/13/requestValidationMode-error.aspx">点击这里查看</a>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">zhanlang</span></span>

      








  


<time datetime="2011-05-13T00:00:00+08:00" pubdate data-updated="true">May 13<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/dotnet/'>DotNet</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/05/12/mvc3ajax-invalid/" title="Previous Post: MVC3ajax无效的问题">&laquo; MVC3ajax无效的问题</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/05/13/requestvalidationmode--dao-zhi--validaterequestfalse--shi-xiao-huo-zhe-asp-net-4-0-shi-jian-xiao-xi---fa-sheng-le-yan-zheng/" title="Next Post: requestValidationMode 导致 ValidateRequest=False 失效或者ASP.NET 4.0事件消息: 发生了验证错误；检测到有潜在危险的Request.Form值">requestValidationMode 导致 ValidateRequest=False 失效或者ASP.NET 4.0事件消息: 发生了验证错误；检测到有潜在危险的Request.Form值 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/12/23/qtqq-v070-beta/">Qtqq v0.7.0-beta</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/23/about-qtqq0-8-0-alpha/">关于qtqq0.8.0-alpha</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/20/typecho-rewrite-rule/">typecho rewrite 规则</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/20/sae-wordpress--zhuan--typecho/">sae wordpress 转 typecho</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/20/linux-visual-diff-tool/">linux可视化差异比较工具 meld</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/zhanlangsir">@zhanlangsir</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'zhanlangsir',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - zhanlang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
